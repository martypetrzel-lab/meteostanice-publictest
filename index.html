<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Meteostanice – Dashboard</title>
  <link rel="stylesheet" href="./style.css" />
</head>
<body>
  <div class="app">
    <header class="top">
      <div class="brand">
        <div class="logo">☀️</div>
        <div>
          <div class="title">Meteostanice</div>
          <div class="subtitle">
            <span id="statusText">Dashboard • načítám…</span>
            <span class="dot">•</span>
            <a id="stateLink" href="#" target="_blank" rel="noreferrer">/state</a>
          </div>
        </div>
      </div>

      <div class="tabs">
        <button class="tab active" data-tab="today">DNES</button>
        <button class="tab" data-tab="history">HISTORIE</button>
        <button class="tab" data-tab="energy">ENERGIE</button>
        <button class="tab" data-tab="settings">NASTAVENÍ</button>
      </div>
    </header>

    <main class="content">
      <!-- DNES -->
      <section class="panel active" id="tab-today">
        <div class="grid2">
          <div class="card">
            <div class="card-h">Prostředí</div>
            <div class="kv">
              <div class="k">Světlo</div><div class="v"><span id="uiLight">—</span> lx</div>
              <div class="k">Teplota</div><div class="v"><span id="uiTemp">—</span> °C</div>
              <div class="k">Vlhkost</div><div class="v"><span id="uiHum">—</span> %</div>
              <div class="k">Box</div><div class="v"><span id="uiBoxTemp">—</span> °C</div>

              <div class="k">Venku</div><div class="v"><span id="uiOutdoorTemp">—</span> °C</div>
              <div class="k">Solární potenciál</div><div class="v"><span id="uiSolarPot">—</span> W</div>
              <div class="k">Scénář</div><div class="v"><span id="uiScenario">—</span></div>
              <div class="k">Fáze 21denního cyklu</div><div class="v"><span id="uiPhase">—</span></div>
            </div>
            <div class="chips" id="uiWeatherChips"></div>
          </div>

          <div class="card">
            <div class="card-h">Energie</div>
            <div class="kv">
              <div class="k">SOC</div><div class="v"><span id="uiSoc">—</span> %</div>
              <div class="k">Solár</div><div class="v"><span id="uiSolar">—</span> W</div>
              <div class="k">Zátěž</div><div class="v"><span id="uiLoad">—</span> W</div>
              <div class="k">Větrák</div><div class="v"><span id="uiFan">—</span></div>

              <!-- T 3.33.0 quick glance -->
              <div class="k">Stav energie</div><div class="v"><span id="uiPowerState">—</span></div>
              <div class="k">Power-path</div><div class="v"><span id="uiPowerPath">—</span></div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-h">Mozek – rozhodnutí</div>

          <div class="brainTop">
            <div class="brainMsg">
              <div class="msg" id="uiMsg">—</div>
              <div class="msgSub" id="uiDetails">—</div>
            </div>
            <div class="brainBadge" id="uiModeBadge">—</div>
          </div>

          <div class="brainGrid">
            <div class="brainMetric">
              <div class="label">Riziko</div>
              <div class="value"><span id="uiRisk">—</span> / 100</div>
              <div class="bar"><div class="barFill" id="uiRiskBar"></div></div>
            </div>

            <div class="brainMetric">
              <div class="label">Výdrž</div>
              <div class="value"><span id="uiBatHours">—</span> h</div>
              <div class="hint" id="uiBatHint">—</div>
            </div>

            <div class="brainMetric">
              <div class="label">Slunce</div>
              <div class="value" id="uiSunLine">—</div>
              <div class="hint" id="uiSunHint">—</div>
            </div>

            <div class="brainMetric">
              <div class="label">Trend rizika</div>
              <canvas id="riskCanvas" width="640" height="140"></canvas>
              <div class="hint">Poslední ~2 hodiny (lokálně v prohlížeči)</div>
            </div>
          </div>

          <div class="chips" id="uiBrainChips"></div>
        </div>
      </section>

      <!-- HISTORIE -->
      <section class="panel" id="tab-history">
        <div class="card">
          <div class="card-h">Historie – grafy + shrnutí</div>
          <div class="row">
            <div class="muted">Den:</div>
            <select id="daySelect" class="select"></select>
            <button id="btnDayPrev" class="btn ghost">←</button>
            <button id="btnDayNext" class="btn ghost">→</button>
            <span class="muted" id="dayInfo">—</span>
          </div>

          <div class="summaryBox">
            <div class="summaryTitle">Denní shrnutí</div>
            <div class="summaryLine" id="daySummaryHeadline">—</div>
            <div class="summaryGrid" id="daySummaryGrid"></div>
            <div class="summaryNote" id="daySummaryNote">—</div>
          </div>

          <div class="grid2">
            <div class="chartCard">
              <div class="chartTitle">Teplota (°C)</div>
              <canvas id="chartTemp"></canvas>
            </div>
            <div class="chartCard">
              <div class="chartTitle">Solár vs Zátěž (W)</div>
              <canvas id="chartPower"></canvas>
            </div>
          </div>

          <div class="grid2">
            <div class="chartCard">
              <div class="chartTitle">Světlo (lx)</div>
              <canvas id="chartLight"></canvas>
            </div>
            <div class="chartCard">
              <div class="chartTitle">Mozek – riziko</div>
              <canvas id="chartBrainRisk"></canvas>
              <div class="muted small">Když backend neposílá risk historii, graf zůstane prázdný (nic se neláme).</div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-h">Týdny – agregace</div>
          <div class="muted">Agregace se dělá klientsky z <code>memory.days</code>.</div>

          <div class="summaryBox">
            <div class="summaryTitle">Týdenní shrnutí</div>
            <div class="summaryLine" id="weekSummaryHeadline">—</div>
            <div class="summaryGrid" id="weekSummaryGrid"></div>
          </div>

          <div class="chartCard">
            <div class="chartTitle">Týdenní min/max teplota (°C)</div>
            <canvas id="chartWeekTemp"></canvas>
          </div>
          <div class="chartCard">
            <div class="chartTitle">Týdenní energie (Wh)</div>
            <canvas id="chartWeekEnergy"></canvas>
            <div class="muted small">Preferuje <code>day.totals.energyInWh / day.totals.energyOutWh</code>. Když nic není, zůstane prázdné.</div>
          </div>
        </div>

        <div class="card">
          <div class="card-h">Timeline událostí</div>
          <div class="muted">Poslední události se ukládají lokálně v prohlížeči.</div>
          <div id="timeline" class="timeline">—</div>
        </div>

        <div class="card">
          <div class="card-h">Export</div>
          <div class="row">
            <button id="btnExportState" class="btn">Export /state JSON</button>
            <button id="btnExportMemory" class="btn ghost">Export memory.days JSON</button>
            <button id="btnExportCSVTemp" class="btn ghost">CSV: teplota</button>
            <button id="btnExportCSVPower" class="btn ghost">CSV: solár/zátěž</button>
            <button id="btnExportCSVLight" class="btn ghost">CSV: světlo</button>
          </div>
          <div class="muted small">CSV exportuje právě vybraný den.</div>
        </div>
      </section>

      <!-- ENERGIE -->
      <section class="panel" id="tab-energy">
        <div class="card">
          <div class="card-h">Tok energie</div>
          <div class="energyFlow">
            <div class="flowBox">
              <div class="flowLabel">Solár</div>
              <div class="flowValue"><span id="uiSolar2">—</span> W</div>
              <div class="muted small">EMA: <span id="uiSolarEma">—</span> W</div>
            </div>
            <div class="flowArrow">➡️</div>
            <div class="flowBox">
              <div class="flowLabel">Baterie</div>
              <div class="flowValue"><span id="uiSoc2">—</span> %</div>
              <div class="muted small">SoC odhad: <span id="uiSocEst">—</span> • jistota: <span id="uiSocConf">—</span></div>
            </div>
            <div class="flowArrow">➡️</div>
            <div class="flowBox">
              <div class="flowLabel">Zátěž</div>
              <div class="flowValue"><span id="uiLoad2">—</span> W</div>
              <div class="muted small">EMA: <span id="uiLoadEma">—</span> W</div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-h">Stavy (T 3.33.0)</div>
          <div class="kv">
            <div class="k">Power state</div><div class="v"><span id="uiPowerState2">—</span></div>
            <div class="k">Power-path</div><div class="v"><span id="uiPowerPath2">—</span></div>
            <div class="k">Kvalita signálu (IN)</div><div class="v"><span id="uiQIn">—</span></div>
            <div class="k">Kvalita signálu (OUT)</div><div class="v"><span id="uiQOut">—</span></div>
            <div class="k">Deadband</div><div class="v"><span id="uiDeadband">—</span> W</div>
          </div>
          <div class="muted small">Kvalita 0–1. Deadband je dynamický „anti-šum“ práh, učí se v IDLE.</div>
        </div>

        <div class="card">
          <div class="card-h">Energie – dnes a 24 hodin</div>
          <div class="kv">
            <div class="k">Dnes IN</div><div class="v"><span id="uiWhInToday">—</span> Wh</div>
            <div class="k">Dnes OUT</div><div class="v"><span id="uiWhOutToday">—</span> Wh</div>
            <div class="k">Dnes NET</div><div class="v"><span id="uiWhNetToday">—</span> Wh</div>

            <div class="k">24h IN</div><div class="v"><span id="uiWhIn24h">—</span> Wh</div>
            <div class="k">24h OUT</div><div class="v"><span id="uiWhOut24h">—</span> Wh</div>
            <div class="k">24h NET</div><div class="v"><span id="uiWhNet24h">—</span> Wh</div>
          </div>
          <div class="muted small">Reset „dnes“ probíhá v lokální půlnoci (Europe/Prague). 24h je bucketový model po hodinách.</div>
        </div>
      </section>

      <!-- NASTAVENÍ -->
      <section class="panel" id="tab-settings">
        <div class="card">
          <div class="card-h">⚙️ Nastavení</div>

          <div class="kv">
            <div class="k">Backend URL</div>
            <div class="v">
              <input id="backendUrl" class="input" placeholder="https://...railway.app" />
            </div>

            <div class="k"></div>
            <div class="v row">
              <button id="btnSave" class="btn">Uložit</button>
              <button id="btnTest" class="btn ghost">Test /health</button>
              <span id="healthOut" class="muted">—</span>
            </div>

            <div class="k">Obnova dat</div>
            <div class="v row">
              <button class="chipBtn" data-interval="1000">1 s</button>
              <button class="chipBtn" data-interval="2000">2 s</button>
              <button class="chipBtn" data-interval="5000">5 s</button>
              <label class="check">
                <input id="chkRaw" type="checkbox" />
                <span>Zobrazit RAW JSON</span>
              </label>
            </div>
          </div>

          <pre class="pre hidden" id="rawJson">—</pre>
        </div>
      </section>
    </main>

    <footer class="foot">
      UI prototype • data z /state • ©
    </footer>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="./app.js"></script>
</body>
</html>
